<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="dark">
    <title>Manga Tool - Add Manga</title>
    <style>html,body{background-color:#000!important;color:#fff!important;margin:0;padding:0}</style>
    <link rel="stylesheet" href="/static/css/styles.css?v=2">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="manga-header">
            <h1><i class="bi bi-book-half"></i>Manga Tool</h1>
            <p class="lead">Process manga CBZ files, extract chapters, and update metadata</p>
        </div>

        <!-- Flash Messages -->
        {{if .Flashes}}
            <div class="alert alert-info fade-in">
                <i class="bi bi-info-circle"></i>
                <div>
                    {{range .Flashes}}
                        {{.Message}}<br>
                    {{end}}
                </div>
            </div>
        {{end}}

        <!-- Navigation Links -->
        <div class="nav-links">
            <ul class="nav nav-tabs">
                <li class="nav-item">
                    <a class="nav-link active" href="/">
                        <i class="bi bi-plus-circle"></i>Add Manga
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/manage-manga">
                        <i class="bi bi-gear"></i>Manage Manga
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/processes">
                        <i class="bi bi-activity"></i>Processes
                    </a>
                </li>
            </ul>
        </div>

        <!-- Main Form -->
        <form action="/upload" method="post" enctype="multipart/form-data" id="add-manga-form">
            <div class="form-section fade-in">
                <!-- Hidden fields - always English, always manga -->
                <input type="hidden" name="language" value="en">
                <input type="hidden" name="is_manga" value="true">

                <!-- Manga Title Section -->
                <div class="card-header">
                    Manga Information
                </div>

                <div class="mb-4">
                    <label for="manga_title" class="form-label">Manga Title</label>
                    <input type="text" class="form-control" id="manga_title" name="manga_title" required placeholder="Enter manga title...">
                </div>

                <!-- Source Options Section -->
                <div class="card-header">
                    Source Files
                </div>

                <div class="row mb-4">
                    <div class="col-lg-12 mb-3">
                        <div class="source-option">
                            <h5>Download Link</h5>
                            <div class="mb-3">
                                <label for="download_url" class="form-label">URL</label>
                                <div class="url-input-group">
                                    <input type="url" class="form-control" id="download_url" name="download_url" placeholder="https://example.com/manga.cbz">
                                    <a href="#" class="btn btn-secondary btn-sm" id="nyaa-search">
                                        <i class="bi bi-search"></i> Search Nyaa
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-12 mb-3">
                        <div class="source-option">
                            <h5>Upload Files</h5>
                            <div class="mb-3">
                                <label for="files" class="form-label">CBZ/ZIP/RAR Files</label>
                                <input class="form-control" type="file" id="files" name="manga_files" multiple accept=".cbz,.zip,.cbr,.rar">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chapter Titles Section -->
                <div class="card-header">
                    Chapter Titles
                </div>

                <div class="mb-4">
                    <div class="mb-3">
                        <label for="mangareader_url" class="form-label">MangaReader.to URL</label>
                        <div class="url-input-group">
                            <input type="url" class="form-control" id="mangareader_url" name="mangareader_url" placeholder="https://mangareader.to/manga-name">
                            <a href="#" class="btn btn-secondary btn-sm" id="mangareader-search">
                                <i class="bi bi-search"></i> Search
                            </a>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="mangadex_url" class="form-label">MangaDex URL</label>
                        <div class="url-input-group">
                            <input type="url" class="form-control" id="mangadex_url" name="mangadex_url" placeholder="https://mangadex.org/title/...">
                            <a href="#" class="btn btn-secondary btn-sm" id="mangadex-search">
                                <i class="bi bi-search"></i> Search
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Processing Options Section -->
                <div class="card-header">
                    Processing Options
                </div>

                <div class="mb-4">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="is_oneshot" name="is_oneshot" value="true">
                        <label class="form-check-label" for="is_oneshot">
                            This is a oneshot (single chapter)
                        </label>
                    </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="as_folder" name="as_folder" value="true">
                            <label class="form-check-label" for="as_folder">
                                Create as folders instead of CBZ files
                            </label>
                        </div>

                    <div class="form-check mb-4">
                        <input class="form-check-input" type="checkbox" id="delete_originals" name="delete_originals" value="true" checked>
                        <label class="form-check-label" for="delete_originals">
                            Delete original volume files after extracting chapters
                        </label>
                    </div>

                    <div style="text-align: center;">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-play-circle"></i>Process Manga
                        </button>
                    </div>
                </div>
            </div>
        </form>

        <!-- Footer -->
        <div class="footer">
            <p>Manga Tool &copy; {{.CurrentYear}}</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get the manga title input element
            const mangaTitleInput = document.getElementById('manga_title');
            const mangareaderUrlInput = document.getElementById('mangareader_url');
            const mangadexUrlInput = document.getElementById('mangadex_url');
            const downloadUrlInput = document.getElementById('download_url');
            
            // Debounce function to limit API calls
            function debounce(func, wait) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            }
            
            // Function to fetch chapter links
            const fetchChapterLinks = debounce(function(title) {
                if (!title || title.length < 3) {
                    // Clear cached values when title is empty or too short
                    mangareaderUrlInput.value = '';
                    mangadexUrlInput.value = '';
                    downloadUrlInput.value = '';
                    const oneshotCheckbox = document.getElementById('is_oneshot');
                    if (oneshotCheckbox) {
                        oneshotCheckbox.checked = false;
                    }
                    return;
                }
                
                fetch(`/api/chapters?title=${encodeURIComponent(title)}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Handle chapter links (data.chapters contains the URLs)
                        if (data.chapters) {
                            // Auto-fill URL fields if available
                            let mangareaderUrl = '';
                            let mangadexUrl = '';
                            let downloadUrl = '';
                            
                            // Find the first URL from each source
                            for (const chapter of data.chapters) {
                                if (chapter.source === 'mangareader' && !mangareaderUrl && chapter.url) {
                                    mangareaderUrl = chapter.url;
                                }
                                if (chapter.source === 'mangadex' && !mangadexUrl && chapter.url) {
                                    mangadexUrl = chapter.url;
                                }
                                if (chapter.source === 'download' && !downloadUrl && chapter.url) {
                                    downloadUrl = chapter.url;
                                }
                            }
                            
                            // Only update if empty or if we have a value
                            if (mangareaderUrl) {
                                mangareaderUrlInput.value = mangareaderUrl;
                            }
                            
                            if (mangadexUrl) {
                                mangadexUrlInput.value = mangadexUrl;
                            }
                            
                            if (downloadUrl) {
                                downloadUrlInput.value = downloadUrl;
                            }
                        }
                        
                        // Handle oneshot status (data.isOneshot)
                        if (data.isOneshot) {
                            const oneshotCheckbox = document.getElementById('is_oneshot');
                            if (oneshotCheckbox) {
                                oneshotCheckbox.checked = true;
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching manga data:', error);
                    });
            }, 500);
            
            // Add event listener to manga title input
            mangaTitleInput.addEventListener('input', function() {
                fetchChapterLinks(this.value.trim());
            });

            // Function to get manga title or use default
            function getMangaTitle() {
                const title = mangaTitleInput.value.trim();
                return title ? title.replace(/\s+/g, '+') : '';
            }

            // Set up the MangaReader search link
            const mangareaderSearchBtn = document.getElementById('mangareader-search');
            mangareaderSearchBtn.addEventListener('click', function(e) {
                e.preventDefault();
                const searchTerm = getMangaTitle();
                if (searchTerm) {
                    window.open(`https://mangareader.to/search?keyword=${searchTerm}`, '_blank');
                } else {
                    window.open('https://mangareader.to/', '_blank');
                }
            });

            // Set up the MangaDex search link
            const mangadexSearchBtn = document.getElementById('mangadex-search');
            mangadexSearchBtn.addEventListener('click', function(e) {
                e.preventDefault();
                const searchTerm = getMangaTitle();
                if (searchTerm) {
                    window.open(`https://mangadex.org/search?q=${searchTerm}`, '_blank');
                } else {
                    window.open('https://mangadex.org/', '_blank');
                }
            });

            // Set up the Nyaa search link
            const nyaaSearchBtn = document.getElementById('nyaa-search');
            nyaaSearchBtn.addEventListener('click', function(e) {
                e.preventDefault();
                const searchTerm = getMangaTitle();
                if (searchTerm) {
                    window.open(`https://nyaa.si/?f=0&c=3_1&q=${searchTerm}`, '_blank');
                } else {
                    window.open('https://nyaa.si/?f=0&c=3_1', '_blank');
                }
            });
        });
    </script>
</body>
</html>
