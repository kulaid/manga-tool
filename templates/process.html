<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="dark">
    <title>Processing Manga - Manga Tool</title>
    <style>html,body{background-color:#000!important;color:#fff!important;margin:0;padding:0}</style>
    <link rel="stylesheet" href="/static/css/styles.css?v=2">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<body>
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1><i class="bi bi-arrow-repeat"></i>Processing {{.manga_title}}</h1>
        </div>
        
        <!-- Status section -->
        <div class="card status-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-activity me-2"></i>Status</h5>
                <div class="button-group">
                    <button id="cancel-process-btn" class="btn btn-sm btn-danger" style="display: none;">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                    <button id="force-cancel-process-btn" class="btn btn-sm btn-danger" style="display: none;">
                        <i class="bi bi-stop-circle"></i> Force Cancel
                    </button>
                    <span id="status-indicator" class="badge bg-primary">Active</span>
                </div>
            </div>
            <div class="card-body">
                <div class="progress mb-3">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="0"></div>
                </div>
                <div id="status-message" class="text-center fw-bold">Initializing...</div>
                <div id="error-message" class="alert alert-danger mt-3" style="display: none;"></div>
            </div>
        </div>
        
        <!-- Interactive section - this is a single container for all interactions -->
        <div id="interactive-section">
                    <!-- Text input section -->
                    <div id="input-container" class="card input-card" style="display: none;">
                        <div class="card-header">
                            <h5 class="mb-0">Input Required</h5>
                        </div>
                        <div class="card-body">
                            <div id="prompt-text" class="prompt-area"></div>
                            <form id="input-form">
                                <div class="mb-3">
                                    <input type="text" class="form-control" id="input-field" placeholder="Your response...">
                                </div>
                                <div class="d-flex justify-content-end">
                                    <button type="button" id="cancel-btn" class="btn btn-outline-secondary me-2">Skip/Cancel</button>
                                    <button type="submit" class="btn btn-primary">Submit</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- File selection section -->
                    <div id="file-selection" class="card input-card" style="display: none;">
                        <div class="card-header">
                            <h5 class="mb-0">Select Files or Folders to Delete</h5>
                        </div>
                        <div class="card-body">
                            <p id="selection-instructions" class="mb-3">You can select both files and folders for deletion.</p>
                            <div id="file-list" class="mb-3" style="max-height: 300px; overflow-y: auto;"></div>
                            <div class="d-flex justify-content-between">
                                <div>
                                    <button id="select-all" class="btn btn-sm btn-outline-secondary">Select All</button>
                                    <button id="deselect-all" class="btn btn-sm btn-outline-secondary ms-2">Deselect All</button>
                                </div>
                                <button id="submit-selection" class="btn btn-primary">Submit</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chapter titles section -->
                    <div id="chapter-titles" class="card input-card" style="display: none;">
                        <div class="card-header">
                            <h5 class="mb-0">Enter Chapter Titles</h5>
                        </div>
                        <div class="card-body">
                            <div id="chapter-list" class="mb-3"></div>
                            <div class="d-flex justify-content-end">
                                <button id="submit-titles" class="btn btn-primary">Submit Titles</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Completion message -->
            <div id="completion" class="card status-card" style="display: none;">
                <div class="card-body text-center py-5">
                    <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                    <h4 class="text-success mb-3 mt-3">Processing Complete!</h4>
                    {{if .update_metadata}}
                    <p class="text-muted mb-4">Your manga metadata has been successfully updated.</p>
                    <a href="/manage-manga" class="btn btn-primary btn-lg">
                        <i class="bi bi-arrow-left me-2"></i>Return to Manage Manga
                    </a>
                    {{else}}
                    <p class="text-muted mb-4">Your manga has been successfully processed and added to your library.</p>
                    <a href="/" class="btn btn-primary btn-lg">
                        <i class="bi bi-plus-circle me-2"></i>Process Another Manga
                    </a>
                    {{end}}
                </div>
            </div>
            
            <!-- Back button -->
            <div class="back-button">
                {{if .update_metadata}}
                <a href="/manage-manga" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-2"></i>Back to Manage Manga
                </a>
                {{else}}
                <a href="/" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-2"></i>Back to Home
                </a>
                {{end}}
            </div>
        </div>
    </div>

    <script src="/static/js/file-list-selector.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Cache DOM elements
            const inputContainer = document.getElementById('input-container');
            const fileSelection = document.getElementById('file-selection');
            const selectionInstructions = document.getElementById('selection-instructions');
            const fileList = document.getElementById('file-list');
            const chapterTitles = document.getElementById('chapter-titles');
            const chapterList = document.getElementById('chapter-list');
            const submitSelection = document.getElementById('submit-selection');
            const submitTitles = document.getElementById('submit-titles');
            const selectAll = document.getElementById('select-all');
            const deselectAll = document.getElementById('deselect-all');
            const statusIndicator = document.getElementById('status-indicator');
            const progressBar = document.getElementById('progress-bar');
            const statusMessage = document.getElementById('status-message');
            const errorMessage = document.getElementById('error-message');
            const completion = document.getElementById('completion');
            
            // Global tracking variables
            let processRunning = true;
            let activeInteraction = false;
            let selectedFiles = [];
            let chapterTitlesData = [];
            let consecutiveFailures = 0;
            let statusCheckInterval = null;
            let fileListSelector = null;
            
            // Prompt types enum
            const PromptType = {
                FILE_DELETION: 'file_deletion',
                CHAPTER_LIST: 'chapter_list',
                CHAPTER_TITLE: 'chapter_title'
            };
            
            // Current prompt type
            let currentPromptType = null;
            
            // Hide all interaction interfaces
            function hideAllInteractions() {
                console.log("Hiding all interactions");
                inputContainer.style.display = 'none';
                fileSelection.style.display = 'none';
                chapterTitles.style.display = 'none';
                activeInteraction = false;
                currentPromptType = null;
            }
            
            // Format bytes to human readable size
            function formatBytes(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            // Format speed to human readable format
            function formatSpeed(bytesPerSecond) {
                return formatBytes(bytesPerSecond) + '/s';
            }
            
            // Initialize status checking
            function checkStatus() {
                fetch('/api/status?id={{.ProcessID}}')
                    .then(response => response.json())
                    .then(data => {
                        console.log('Status update:', data);
                        consecutiveFailures = 0;
                        
                        // Update progress information
                        if (data.total > 0) {
                            const percentage = Math.round((data.progress / data.total) * 100);
                        progressBar.style.width = percentage + '%';
                        progressBar.setAttribute('aria-valuenow', percentage);
                    } else {
                        progressBar.style.width = '0%';
                        progressBar.setAttribute('aria-valuenow', 0);
                    }
                    
                    // Parse and format the status message
                    let displayMessage = data.message || 'Processing...';
                    
                    // Check if we have dedicated download speed info from API
                    if (data.download_speed && data.download_speed > 0) {
                        const speed = formatSpeed(data.download_speed);
                        const speedBadge = document.createElement('span');
                        speedBadge.className = 'badge bg-info ms-2';
                        speedBadge.innerHTML = '<i class="bi bi-download me-1"></i>' + speed;
                        
                        statusMessage.textContent = displayMessage + ' ';
                        statusMessage.appendChild(speedBadge);
                    } else {
                        // Fallback: Extract download speed from message text if present
                        // Look for patterns like "PROGRESS: ... 1.5MB/s" or "... 500KB/s"
                        const speedMatch = displayMessage.match(/(\d+(?:\.\d+)?)\s*(KB|MB|GB)\/s/i);
                        if (speedMatch) {
                            const speed = speedMatch[1];
                            const unit = speedMatch[2];
                            
                            // Check if message contains PROGRESS: prefix and make it more readable
                            if (displayMessage.includes('PROGRESS:')) {
                                // Extract just the progress bar portion if it exists
                                const progressBarMatch = displayMessage.match(/(\d+)%.*?(\d+(?:\.\d+)?[KMG]B\/s)/);
                                if (progressBarMatch) {
                                    const pct = progressBarMatch[1];
                                    const spd = progressBarMatch[2];
                                    
                                    const speedBadge = document.createElement('span');
                                    speedBadge.className = 'badge bg-info ms-2';
                                    speedBadge.innerHTML = '<i class="bi bi-download me-1"></i>' + spd;
                                    
                                    statusMessage.textContent = `Downloading... ${pct}% `;
                                    statusMessage.appendChild(speedBadge);
                                } else {
                                    statusMessage.textContent = displayMessage;
                                }
                            } else {
                                // Just highlight the speed in the message
                                const parts = displayMessage.split(speedMatch[0]);
                                statusMessage.textContent = parts[0];
                                
                                const speedBadge = document.createElement('span');
                                speedBadge.className = 'badge bg-info ms-2';
                                speedBadge.innerHTML = '<i class="bi bi-download me-1"></i>' + speed + ' ' + unit + '/s';
                                statusMessage.appendChild(speedBadge);
                                
                                if (parts[1]) {
                                    statusMessage.appendChild(document.createTextNode(parts[1]));
                                }
                            }
                        } else {
                            statusMessage.textContent = displayMessage;
                        }
                    }
                        
                        // Check for waiting input
                        if (data.waiting_input) {
                            handlePrompt(data.input_prompt, data.input_type, data.safe_html);
                        } else if (activeInteraction) {
                            // If no longer waiting for input but UI is showing, hide it
                            hideAllInteractions();
                        }
                        
                        // Update processing status
                        if (data.status === 'running') {
                            processRunning = true;
                            statusIndicator.className = 'badge bg-primary';
                            statusIndicator.textContent = 'Processing';
                            // Show cancel buttons when process is running
                            document.getElementById('cancel-process-btn').style.display = 'inline-block';
                            document.getElementById('force-cancel-process-btn').style.display = 'inline-block';
                        } else if (data.status === 'complete') {
                            processRunning = false;
                            hideAllInteractions();
                            statusIndicator.className = 'badge bg-success';
                            statusIndicator.textContent = 'Completed';
                            // Hide cancel buttons when process is complete
                            document.getElementById('cancel-process-btn').style.display = 'none';
                            document.getElementById('force-cancel-process-btn').style.display = 'none';
                            completion.style.display = 'block';
                            clearInterval(statusCheckInterval);
                        } else if (data.status === 'failed') {
                            processRunning = false;
                            hideAllInteractions();
                            statusIndicator.className = 'badge bg-danger';
                            statusIndicator.textContent = 'Failed';
                            // Hide cancel buttons when process has failed
                            document.getElementById('cancel-process-btn').style.display = 'none';
                            document.getElementById('force-cancel-process-btn').style.display = 'none';
                            
                            if (data.error) {
                                errorMessage.textContent = data.error;
                                errorMessage.style.display = 'block';
                            }
                            
                            clearInterval(statusCheckInterval);
                        } else if (data.status === 'cancelled') {
                            processRunning = false;
                            hideAllInteractions();
                            statusIndicator.className = 'badge bg-warning';
                            statusIndicator.textContent = 'Cancelled';
                            // Hide cancel buttons when process is cancelled
                            document.getElementById('cancel-process-btn').style.display = 'none';
                            document.getElementById('force-cancel-process-btn').style.display = 'none';
                            clearInterval(statusCheckInterval);
                        }
                        
                        if (processRunning) {
                            statusCheckInterval = setTimeout(checkStatus, 1000);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching status:', error);
                        if (processRunning && consecutiveFailures++ < 5) {
                            statusCheckInterval = setTimeout(checkStatus, 2000 * Math.min(consecutiveFailures, 10));
                        }
                    });
            }

            
            // Handle different prompt types
            function handlePrompt(prompt, inputType, safeHtml) {
                if (!prompt) return;
                
                console.log('Handling prompt:', prompt, 'Safe HTML:', safeHtml);
                
                // Handle HTML formatted prompt
                if (safeHtml) {
                    handleGenericPrompt(prompt, true);
                    return;
                }
                
                // Use the inputType if provided to determine handling
                if (inputType === PromptType.FILE_DELETION) {
                    handleFileDeletionPrompt(prompt);
                    return;
                }
                
                // Determine prompt type for plain text if type not provided
                if (prompt.includes("DO YOU WANT TO DELETE ANY FILES BEFORE PROCESSING") || 
                    prompt.includes("files or folders would you like to delete") || 
                    prompt.includes("file or folder numbers to delete") ||
                    prompt.includes("VOLUMES:") ||
                    prompt.includes("WAITING FOR INPUT: Enter file or folder numbers")) {
                    handleFileDeletionPrompt(prompt);
                }
                else if (prompt.includes("chapter list would you like to use") ||
                         prompt.includes("Found the following chapters")) {
                    handleChapterListPrompt(prompt);
                }
                else if (prompt.includes("Enter missing chapter title") ||
                         prompt.includes("title needed") ||
                         prompt.includes("Chapter") && prompt.includes("title")) {
                    handleChapterTitlePrompt(prompt);
                }
                else {
                    // Generic prompt fallback
                    handleGenericPrompt(prompt, false);
                }
            }
            
            // Handle file deletion prompt
            function handleFileDeletionPrompt(prompt) {
                // Skip if already handling this type of prompt
                if (activeInteraction && currentPromptType === PromptType.FILE_DELETION) {
                    return;
                }
                
                // Hide any active UI
                hideAllInteractions();
                
                // Set state
                activeInteraction = true;
                currentPromptType = PromptType.FILE_DELETION;
                
                // Set instructions
                selectionInstructions.textContent = prompt.split('\n')[0] || 
                    "Which files would you like to delete?";
                
                // Parse file list
                parseFileList(prompt);
                
                // Show UI
                fileSelection.style.display = 'block';
            }
            
            // Parse file list from prompt message
            function parseFileList(prompt) {
                selectedFiles = [];
                fileList.innerHTML = '';
                
                // Extract VOLUMES section
                const volumeRegex = /VOLUMES:\s*\n((?:\d+\.\s+\[[^\]]+\][^\n]*\n?)+)/;
                const volumeMatch = volumeRegex.exec(prompt);
                
                if (volumeMatch) {
                    const volumeListStr = volumeMatch[1];
                    const itemRegex = /(\d+)\.\s+\[([^\]]+)\]\s+(.*?)(?=\n|$)/g;
                    let match;
                    
                    while ((match = itemRegex.exec(volumeListStr)) !== null) {
                        addFileToList(match[1].trim(), '[' + match[2] + '] ' + match[3].trim());
                    }
                }
                
                // Extract CHAPTERS section
                const chapterRegex = /CHAPTERS:\s*\n((?:\d+\.\s+\[[^\]]+\][^\n]*\n?)+)/;
                const chapterMatch = chapterRegex.exec(prompt);
                
                if (chapterMatch) {
                    const chapterListStr = chapterMatch[1];
                    const itemRegex = /(\d+)\.\s+\[([^\]]+)\]\s+(.*?)(?=\n|$)/g;
                    let match;
                    
                    while ((match = itemRegex.exec(chapterListStr)) !== null) {
                        addFileToList(match[1].trim(), '[' + match[2] + '] ' + match[3].trim());
                    }
                }
                
                // Fallback to simple numbered lines
                if (fileList.children.length === 0) {
                    const lines = prompt.split('\n');
                    const lineRegex = /^\s*(\d+)\.\s+(.*?)$/;
                    
                    for (const line of lines) {
                        const match = lineRegex.exec(line);
                        if (match) {
                            addFileToList(match[1].trim(), match[2].trim());
                        }
                    }
                }
                
                // Initialize file list selector with range selection support after list is populated
                setTimeout(() => {
                    if (fileListSelector) {
                        fileListSelector.refresh();
                    } else {
                        fileListSelector = new FileListSelector('#file-list', {
                            checkboxClass: 'file-checkbox',
                            selectAllBtn: '#select-all',
                            deselectAllBtn: '#deselect-all',
                            onChange: (selectedValues) => {
                                selectedFiles = selectedValues;
                                console.log(`Selected ${selectedValues.length} files`);
                            }
                        });
                    }
                }, 100);
            }
            
            // Add a file to the selection list
            function addFileToList(id, name) {
                const item = document.createElement('div');
                item.className = 'file-item';
                
                const formCheck = document.createElement('div');
                formCheck.className = 'form-check';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'form-check-input file-checkbox';
                checkbox.id = 'file-' + id;
                checkbox.value = id;
                
                // Note: Event listeners are handled by FileListSelector
                // No need to add manual listeners here
                
                const label = document.createElement('label');
                label.className = 'form-check-label';
                label.htmlFor = 'file-' + id;
                label.textContent = id + '. ' + name;
                
                formCheck.appendChild(checkbox);
                formCheck.appendChild(label);
                item.appendChild(formCheck);
                fileList.appendChild(item);
            }
            
            // Handle chapter list prompt
            function handleChapterListPrompt(prompt) {
                // Skip if already handling this type of prompt
                if (activeInteraction && currentPromptType === PromptType.CHAPTER_LIST) {
                    return;
                }
                
                // Hide any active UI
                hideAllInteractions();
                
                // Set state
                activeInteraction = true;
                currentPromptType = PromptType.CHAPTER_LIST;
                
                // Clear and set up chapter list UI
                chapterList.innerHTML = '';
                
                // Extract the main prompt message (first line)
                const promptLines = prompt.split('\n');
                const mainPrompt = promptLines[0] || "Which chapter list would you like to use?";
                
                // Create main prompt header
                const promptHeader = document.createElement('h4');
                promptHeader.className = 'mb-3';
                promptHeader.textContent = mainPrompt;
                chapterList.appendChild(promptHeader);
                
                // Check if this is a prompt showing chapters that need titles
                const isChapterTitlesList = prompt.includes("Found the following chapters that need titles") || 
                                           prompt.includes("Please provide titles for each chapter when prompted");
                
                // If this is the initial list of chapters needing titles, add a Skip All button
                if (isChapterTitlesList) {
                    const skipAllContainer = document.createElement('div');
                    skipAllContainer.className = 'alert alert-primary d-flex flex-column align-items-center p-4 mb-4';
                    
                    const skipTitle = document.createElement('h5');
                    skipTitle.className = 'mb-3 text-center';
                    skipTitle.innerHTML = 'No Need to Enter Chapter Titles?';
                    skipAllContainer.appendChild(skipTitle);
                    
                    const skipAllButton = document.createElement('button');
                    skipAllButton.className = 'btn btn-lg btn-primary mb-2';
                    skipAllButton.style.minWidth = '250px';
                    skipAllButton.innerHTML = '<i class="bi bi-skip-forward-fill me-2"></i> Skip All Titles';
                    skipAllButton.addEventListener('click', function() {
                        // Send a special response to skip all chapter title inputs
                        submitPromptResponse("__SKIP_ALL_TITLES__");
                    });
                    skipAllContainer.appendChild(skipAllButton);
                    
                    const helpText = document.createElement('div');
                    helpText.className = 'small text-center mt-2';
                    helpText.innerHTML = 'This will use default names (Chapter 1, Chapter 2, etc.)';
                    skipAllContainer.appendChild(helpText);
                    
                    chapterList.appendChild(skipAllContainer);
                }
                
                // Format and display the chapter lists in a more readable way
                const listsContainer = document.createElement('div');
                listsContainer.className = 'list-group mb-3';
                
                // Process each line of the prompt to create a structured display
                let currentList = null;
                let listItems = [];
                let automaticSelection = false;
                
                // Check if automatic selection message is present
                for (let i = 1; i < promptLines.length; i++) {
                    if (promptLines[i].includes("Automatically selected the only available chapter list")) {
                        automaticSelection = true;
                        break;
                    }
                }
                
                if (automaticSelection) {
                    const autoMessage = document.createElement('div');
                    autoMessage.className = 'alert alert-info';
                    autoMessage.innerHTML = '<i class="bi bi-info-circle"></i> Automatically selected the only available chapter list.';
                    chapterList.appendChild(autoMessage);
                }
                
                for (let i = 1; i < promptLines.length; i++) {
                    const line = promptLines[i].trim();
                    if (!line) continue;
                    
                    // Check if this is a list header line
                    const listMatch = line.match(/^List (\d+) \((\d+) chapters, ([A-Za-z]+) quality\):$/);
                    if (listMatch) {
                        // If we have a previous list, add it to the container
                        if (currentList && listItems.length > 0) {
                            addListToContainer(listsContainer, currentList, listItems);
                        }
                        
                        // Start a new list
                        currentList = {
                            number: listMatch[1],
                            count: listMatch[2],
                            quality: listMatch[3]
                        };
                        listItems = [];
                    } else if (line.startsWith('-') && currentList) {
                        // This is a chapter item
                        listItems.push(line.substring(1).trim());
                    }
                }
                
                // Add the last list if we have one
                if (currentList && listItems.length > 0) {
                    addListToContainer(listsContainer, currentList, listItems);
                }
                
                chapterList.appendChild(listsContainer);
                
                // Create input group
                const inputGroup = document.createElement('div');
                inputGroup.className = 'input-group mb-3';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'form-control';
                input.id = 'chapter-list-input';
                input.placeholder = 'Enter your selection (1, 2, etc.)';
                
                // Add keydown handler for Enter key
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        submitPromptResponse(input.value);
                    }
                });
                
                const submitBtn = document.createElement('button');
                submitBtn.className = 'btn btn-primary';
                submitBtn.textContent = 'Submit';
                submitBtn.addEventListener('click', function() {
                    submitPromptResponse(input.value);
                });
                
                inputGroup.appendChild(input);
                inputGroup.appendChild(submitBtn);
                chapterList.appendChild(inputGroup);
                
                // Show UI
                chapterTitles.style.display = 'block';
                
                // Focus input
                setTimeout(() => input.focus(), 100);
            }
            
            // Helper function to add a formatted list to the container
            function addListToContainer(container, list, items) {
                const listItem = document.createElement('div');
                listItem.className = 'list-group-item';
                
                const listHeader = document.createElement('h5');
                listHeader.className = 'mb-2';
                listHeader.innerHTML = `List <span class="badge bg-primary">${list.number}</span> <small>(${list.count} chapters, <span class="${list.quality.toLowerCase() === 'high' ? 'text-success' : list.quality.toLowerCase() === 'medium' ? 'text-warning' : 'text-danger'}">${list.quality} quality</span>)</small>`;
                listItem.appendChild(listHeader);
                
                const chaptersContainer = document.createElement('ul');
                chaptersContainer.className = 'list-unstyled mb-0 ps-3';
                
                items.forEach(item => {
                    const chapterItem = document.createElement('li');
                    chapterItem.innerHTML = `<i class="bi bi-book me-2"></i> ${item}`;
                    chaptersContainer.appendChild(chapterItem);
                });
                
                listItem.appendChild(chaptersContainer);
                container.appendChild(listItem);
            }
            
            // Handle chapter title prompt
            function handleChapterTitlePrompt(prompt) {
                // Skip if already handling this type of prompt
                if (activeInteraction && currentPromptType === PromptType.CHAPTER_TITLE) {
                    return;
                }
                
                // Hide any active UI
                hideAllInteractions();
                
                // Set state
                activeInteraction = true;
                currentPromptType = PromptType.CHAPTER_TITLE;
                
                // Parse chapter number
                const chapterMatch = /Chapter (\d+(\.\d+)?)/i.exec(prompt);
                const chapterNumber = chapterMatch ? chapterMatch[1] : 'unknown';
                
                // Clear chapter titles data
                chapterTitlesData = [{
                    chapter: chapterNumber,
                    title: ''
                }];
                
                // Clear and set up chapter titles UI
                chapterList.innerHTML = '';
                
                // Create title input for the chapter
                const formGroup = document.createElement('div');
                formGroup.className = 'mb-3';

                const label = document.createElement('label');
                label.className = 'form-label';
                label.htmlFor = 'chapter-title-input';
                label.textContent = prompt;

                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'form-control';
                input.id = 'chapter-title-input';
                input.placeholder = `Enter title for Chapter ${chapterNumber}`;

                // Add keydown handler for Enter key
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        submitChapterTitle();
                    }
                });

                formGroup.appendChild(label);
                formGroup.appendChild(input);
                chapterList.appendChild(formGroup);

                // Button group for submit and skip
                const btnGroup = document.createElement('div');
                btnGroup.className = 'd-flex justify-content-end';

                // Skip button
                const skipBtn = document.createElement('button');
                skipBtn.type = 'button';
                skipBtn.className = 'btn btn-outline-secondary me-2';
                skipBtn.textContent = 'Skip';
                skipBtn.onclick = function() {
                    submitPromptResponse("__SKIP_ALL_TITLES__");
                };
                btnGroup.appendChild(skipBtn);

                // Submit button (reuse existing)
                submitTitles.onclick = submitChapterTitle;
                btnGroup.appendChild(submitTitles);

                chapterList.appendChild(btnGroup);

                // Show UI
                chapterTitles.style.display = 'block';

                // Focus input
                setTimeout(() => input.focus(), 100);
            }
            
            // Handle any other prompt type
            function handleGenericPrompt(prompt, isHtml) {
                // Hide any active UI
                hideAllInteractions();
                
                // Set state
                activeInteraction = true;
                
                // Display container for input
                const inputContainer = document.getElementById('input-container');
                const promptText = document.getElementById('prompt-text');
                const inputField = document.getElementById('input-field');
                
                // Set prompt content - either as HTML or text
                if (isHtml) {
                    promptText.innerHTML = prompt;
                } else {
                    promptText.textContent = prompt;
                }
                
                // Set up input form handler
                const inputForm = document.getElementById('input-form');
                inputForm.onsubmit = function(e) {
                    e.preventDefault();
                    submitPromptResponse(inputField.value);
                };
                
                // Show the input container
                inputContainer.style.display = 'block';
                
                // Focus the input field
                setTimeout(() => inputField.focus(), 100);
            }
            
            // Submit file selection
            function submitFileSelection() {
                submitPromptResponse(selectedFiles.join(','));
            }
            
            // Submit chapter title
            function submitChapterTitle() {
                const input = document.getElementById('chapter-title-input');
                if (input) {
                    submitPromptResponse(input.value);
                }
            }
            
            // Submit response to server
            function submitPromptResponse(response) {
                fetch('/api/prompt-response', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        response: response
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Response submitted:', data);
                    hideAllInteractions();
                })
                .catch(error => {
                    console.error('Error submitting response:', error);
                });
            }
            
            // Event listeners for file selection
            submitSelection.addEventListener('click', submitFileSelection);
            
            // Note: Select All and Deselect All are now handled by FileListSelector
            // which provides range selection support (Shift+Click)
            
            // Cancel and Force Cancel button handlers
            const cancelBtn = document.getElementById('cancel-process-btn');
            const forceCancelBtn = document.getElementById('force-cancel-process-btn');
            
            cancelBtn.addEventListener('click', function() {
                if (confirm('Are you sure you want to cancel this process?')) {
                    fetch('/api/processes/{{.ProcessID}}/cancel', { 
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            statusMessage.textContent = 'Process cancelled';
                            cancelBtn.style.display = 'none';
                            forceCancelBtn.style.display = 'none';
                            processRunning = false;
                            hideAllInteractions();
                        } else {
                            alert('Failed to cancel process');
                        }
                    })
                    .catch(error => {
                        console.error('Error cancelling process:', error);
                        alert('Error cancelling process');
                    });
                }
            });
            
            forceCancelBtn.addEventListener('click', function() {
                if (confirm('Are you sure you want to force cancel this process? This will stop it immediately.')) {
                    fetch('/api/processes/{{.ProcessID}}/cancel?force=true', { 
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            statusMessage.textContent = 'Process force cancelled';
                            cancelBtn.style.display = 'none';
                            forceCancelBtn.style.display = 'none';
                            processRunning = false;
                            hideAllInteractions();
                        } else {
                            alert('Failed to force cancel process');
                        }
                    })
                    .catch(error => {
                        console.error('Error force cancelling process:', error);
                        alert('Error force cancelling process');
                    });
                }
            });
            
            // Start status polling
            hideAllInteractions();
            checkStatus();
        });
    </script>
</body>
</html>
